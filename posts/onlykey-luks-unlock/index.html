<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Unlocking LUKS volumes with your OnlyKey
        
    </title><meta content="Unlocking LUKS volumes with your OnlyKey" property=og:title><link href=https://hazell.dev/fonts.css rel=stylesheet><script src=https://hazell.dev/js/codeblock.js></script><script src=https://hazell.dev/js/toc.js></script><script src=https://hazell.dev/js/note.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://hazell.dev/atom.xml rel=alternate title=hazell.dev type=application/atom+xml><link href=https://hazell.dev/theme/light.css rel=stylesheet><link href=https://hazell.dev/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://hazell.dev/js/themetoggle.js></script><script>setTheme(getSavedTheme())</script><link href=https://hazell.dev/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://hazell.dev>hazell.dev</a><div class=socials><a class=social href=https://github.com/lewishazell rel=me> <img alt=github src=https://hazell.dev/social_icons/github.svg> </a></div></div><nav><a href=https://hazell.dev/posts style=margin-left:.5em>/posts</a><a href=https://hazell.dev/portfolio style=margin-left:.5em>/portfolio</a><a href=https://hazell.dev/tags style=margin-left:.5em>/tags</a> |<a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://hazell.dev/feather/sun.svg style=filter:invert(1)> <img alt=Dark id=moon-icon src=https://hazell.dev/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Unlocking LUKS volumes with your OnlyKey<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2024-09-14</time><span class=tags-label> :: Tags:</span><span class=tags> <a class=post-tag href=https://hazell.dev/tags/onlykey/>onlykey</a>, <a class=post-tag href=https://hazell.dev/tags/luks/>luks</a>, <a class=post-tag href=https://hazell.dev/tags/setup/>setup</a>, <a class=post-tag href=https://hazell.dev/tags/fido2/>fido2</a>, <a class=post-tag href=https://hazell.dev/tags/diceware/>diceware</a>, <a class=post-tag href=https://hazell.dev/tags/systemd/>systemd</a> </span></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://hazell.dev/posts/onlykey-luks-unlock/#pre-setup>Pre-setup</a> <ul><li><a href=https://hazell.dev/posts/onlykey-luks-unlock/#systemd-version>systemd version</a><li><a href=https://hazell.dev/posts/onlykey-luks-unlock/#disable-grub-menu-timeout>Disable GRUB menu timeout</a></ul><li><a href=https://hazell.dev/posts/onlykey-luks-unlock/#setup>Setup</a> <ul><li><a href=https://hazell.dev/posts/onlykey-luks-unlock/#enroll-your-token>Enroll your token</a><li><a href=https://hazell.dev/posts/onlykey-luks-unlock/#allow-fido2-unlocking-via-crypttab>Allow FIDO2 unlocking via crypttab</a><li><a href=https://hazell.dev/posts/onlykey-luks-unlock/#regenerate-initramfs>Regenerate initramfs</a></ul><li><a href=https://hazell.dev/posts/onlykey-luks-unlock/#teardown>Teardown</a></ul></div><section class=body><p>A while ago, I purchased an OnlyKey Duo. I intended to use it for GPG, SSH and MFA. Alas, I still have very little use for GPG. However, I'm pretty tired of typing in a sufficiently long <a href=https://www.eff.org/dice>diceware</a> passphrase when I start my laptop.<p>The <a href=https://docs.onlykey.io/full-disk-encryption.html>OnlyKey documentation</a> is pretty limited on this topic and links to a repository which is still in alpha. Can we do better?<p>As it turns out, you can use <code>systemd-cryptenroll</code> with the OnlyKey's FIDO2 capabilities for a well supported solution.<h1 id=pre-setup><a aria-label="Anchor link for: pre-setup" class=zola-anchor href=#pre-setup>Pre-setup</a></h1><p>I'm assuming you already have a LUKS2 volume set up with a passphrase. If you don't, I recommend you do as a passphrase will allow you to access your machine if you lose your OnlyKey.<p>If you want to remove passphrases, I recommend taking a recovery key in its place and keeping it somewhere safe:<pre style=background:#2b303b;color:#c0c5ce><code><span>$ sudo systemd-cryptenroll --recovery-key /dev/sda3
</span></code></pre><p>(Replace <em>/dev/sda3</em> with the underlying block device of your encrypted volume)<h2 id=systemd-version><a aria-label="Anchor link for: systemd-version" class=zola-anchor href=#systemd-version>systemd version</a></h2><p>For this setup to work, you need <em>systemd</em> version 248 or above, you can check this with<pre style=background:#2b303b;color:#c0c5ce><code><span>$ systemctl --version
</span></code></pre><p>For example, I am running version 255<blockquote><p>systemd 255 (255.10-3.fc40)</blockquote><h2 id=disable-grub-menu-timeout><a aria-label="Anchor link for: disable-grub-menu-timeout" class=zola-anchor href=#disable-grub-menu-timeout>Disable GRUB menu timeout</a></h2><p>A problem you will face is that you need to unlock your OnlyKey before user presence is requested. It's only requested once and doesn't leave enough time to input your PIN.<p>I found that the GRUB boot menu is the perfect opportunity to unlock my OnlyKey and proceed when I'm ready. User presence isn't requested until Linux boots.<p>To allow yourself time, disable the GRUB menu timeout by setting <code>GRUB_TIMEOUT</code> to <code>-1</code> in <em>/etc/default/grub</em>:<pre style=background:#2b303b;color:#c0c5ce><code><span>$ sudoedit /etc/default/grub
</span><span>[sudo] password for user:
</span><span>
</span><span># If you change this file, run 'update-grub' afterwards to update
</span><span># /boot/grub/grub.cfg.
</span><span>...
</span><span>GRUB_TIMEOUT=-1
</span><span>...
</span></code></pre><p>After modifying <em>/etc/default/grub</em>, you need to update <em>/boot/grub/grub.cfg</em> to reflect your changes. Do so by running <code>update-grub</code>:<pre style=background:#2b303b;color:#c0c5ce><code><span>$ sudo update-grub
</span></code></pre><h1 id=setup><a aria-label="Anchor link for: setup" class=zola-anchor href=#setup>Setup</a></h1><p>With that out of the way, let's enroll the OnlyKey with your LUKS2 volume, configure crypttab to enable FIDO2 unlock and regenerate initramfs.<h2 id=enroll-your-token><a aria-label="Anchor link for: enroll-your-token" class=zola-anchor href=#enroll-your-token>Enroll your token</a></h2><p>To enroll your OnlyKey as an additional way to unlock your volume, run the command<pre style=background:#2b303b;color:#c0c5ce><code><span>$ sudo systemd-cryptenroll --fido2-device=auto --fido2-with-client-pin=false --fido2-with-user-presence=true /dev/sda3
</span></code></pre><p>(Replace <em>/dev/sda3</em> with the underlying block device of your encrypted volume)<p>This embeds the information for FIDO2 unlock with your OnlyKey in the LUKS2 header of your volume.<p>I have set <code>--fido2-with-client-pin=false</code> because I rely on the OnlyKey hardware PIN input. If you have also set a client PIN, you will want to set this to <code>true</code>.<h2 id=allow-fido2-unlocking-via-crypttab><a aria-label="Anchor link for: allow-fido2-unlocking-via-crypttab" class=zola-anchor href=#allow-fido2-unlocking-via-crypttab>Allow FIDO2 unlocking via crypttab</a></h2><p>For FIDO2 unlock to work, it needs to be enabled in <em>/etc/crypttab</em> by appending the <code>fido2-device=auto</code> option on the line configuring your volume:<pre style=background:#2b303b;color:#c0c5ce><code><span>$ sudoedit /etc/crypttab
</span><span>[sudo] password for user:
</span><span>
</span><span>...
</span><span>myvolume /dev/sda3 - fido2-device=auto
</span><span>...
</span></code></pre><p>(<em>/dev/sda3</em> will appear as your block device, it may also be expressed as a UUID)<h2 id=regenerate-initramfs><a aria-label="Anchor link for: regenerate-initramfs" class=zola-anchor href=#regenerate-initramfs>Regenerate initramfs</a></h2><p>Before rebooting your machine, regenerate your initramfs by running:<pre style=background:#2b303b;color:#c0c5ce><code><span>$ sudo dracut --regenerate-all --force
</span></code></pre><p>Now it's all ready to rock. Reboot your machine, enter your OnlyKey PIN, select your distro and your OnlyKey should flash blue to unlock the machine!<h1 id=teardown><a aria-label="Anchor link for: teardown" class=zola-anchor href=#teardown>Teardown</a></h1><p>Just for completeness, you can remove your OnlyKey as a key for your LUKS volume.<p>Given this is your first token, it's probably going to have an ID of <code>0</code>. You can remove it from the LUKS volume by running:<pre style=background:#2b303b;color:#c0c5ce><code><span>$ sudo cryptsetup token remove --token-id 0 /dev/sda3
</span></code></pre><p>and then remove the corresponding key slot by running:<pre style=background:#2b303b;color:#c0c5ce><code><span>$ sudo systemd-cryptenroll --wipe-slot=1 /dev/sda3
</span></code></pre><p>(Replace <em>/dev/sda3</em> with the underlying block device of your encrypted volume)</section></article></main></div>